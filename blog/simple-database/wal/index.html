<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.be2c80d5bf6d264c3cbf.css" id="gatsby-global-css">/*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:IBM Plex Sans,Helvetica Neue,Arial,sans-serif;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.border-current{border-color:currentColor}.rounded-full{border-radius:9999px}.border-solid{border-style:solid}.border{border-width:1px}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.flex-row{flex-direction:row}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.flex-1{flex:1 1 0%}.font-thin{font-weight:100}.font-light{font-weight:300}.font-semibold{font-weight:600}.h-64{height:16rem}.h-full{height:100%}.text-sm{font-size:.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem}.text-lg,.text-xl{line-height:1.75rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.m-6{margin:1.5rem}.mx-4{margin-left:1rem;margin-right:1rem}.mx-6{margin-left:1.5rem;margin-right:1.5rem}.my-8{margin-top:2rem;margin-bottom:2rem}.my-16{margin-top:4rem;margin-bottom:4rem}.my-64{margin-top:16rem;margin-bottom:16rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.ml-4{margin-left:1rem}.mt-6{margin-top:1.5rem}.mr-6{margin-right:1.5rem}.mb-6{margin-bottom:1.5rem}.ml-6{margin-left:1.5rem}.mt-8{margin-top:2rem}.mb-8{margin-bottom:2rem}.ml-8{margin-left:2rem}.mt-12{margin-top:3rem}.mt-16{margin-top:4rem}.-mt-px{margin-top:-1px}.-ml-px{margin-left:-1px}.max-w-4xl{max-width:56rem}.overflow-hidden{overflow:hidden}.p-8{padding:2rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-16{padding-top:4rem;padding-bottom:4rem}.py-24{padding-top:6rem;padding-bottom:6rem}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.right-8{right:2rem}.bottom-8{bottom:2rem}*{--tw-shadow:0 0 transparent;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 transparent;--tw-ring-shadow:0 0 transparent}.hover\:underline:hover{text-decoration:underline}.w-8{width:2rem}.z-50{z-index:50}.gap-x-12{column-gap:3rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.col-span-1{grid-column:span 1/span 1}.col-span-3{grid-column:span 3/span 3}.col-span-4{grid-column:span 4/span 4}.transform{--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;transform:translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{transform:translateY(-25%);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;animation-timing-function:cubic-bezier(0,0,.2,1)}}@font-face{font-family:IBM Plex Sans;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexsans/v8/zYX9KVElMYYaJe8bpLHnCwDKjXr8AIFsdP3pBms.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:IBM Plex Sans;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexsans/v8/zYXgKVElMYYaJe8bpLHnCwDKhdHeFaxOedc.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:IBM Plex Sans;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexsans/v8/zYX9KVElMYYaJe8bpLHnCwDKjQ76AIFsdP3pBms.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:"IBM Plex Serif";font-style:italic;font-weight:400;font-display:swap;src:local("IBM Plex Serif Italic"),local("IBMPlexSerif-Italic"),url(https://fonts.gstatic.com/s/ibmplexserif/v8/jizBREVNn1dOx-zrZ2X3pZvkTiUa6zUTjnTLgNs.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:"IBM Plex Serif";font-style:normal;font-weight:400;font-display:swap;src:local("IBM Plex Serif"),local("IBMPlexSerif"),url(https://fonts.gstatic.com/s/ibmplexserif/v8/jizDREVNn1dOx-zrZ2X3pZvkTiUf2zcZiVbJ.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:"IBM Plex Serif";font-style:normal;font-weight:600;font-display:swap;src:local("IBM Plex Serif SemiBold"),local("IBMPlexSerif-SemiBold"),url(https://fonts.gstatic.com/s/ibmplexserif/v8/jizAREVNn1dOx-zrZ2X3pZvkTi3A_yI0q1vjitOh.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}body,html{background-color:#161616}body,h1,h2,h3,h4,h5,h6,html,p,span{color:#f4f4f4}@media (min-width:1024px){.lg\:block{display:block}.lg\:hidden{display:none}.lg\:h-full{height:100%}.lg\:text-xl{font-size:1.25rem;line-height:1.75rem}.lg\:mt-0{margin-top:0}.lg\:mt-4{margin-top:1rem}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.lg\:grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.lg\:grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.lg\:col-span-2{grid-column:span 2/span 2}.lg\:col-span-3{grid-column:span 3/span 3}.lg\:col-span-4{grid-column:span 4/span 4}.lg\:col-span-8{grid-column:span 8/span 8}.lg\:col-span-12{grid-column:span 12/span 12}}.nav-items{display:inline-flex;align-items:center}.mobile-nav{background:#161616;top:80px}.link-svg-fill{fill:#0062ff}.link-1-color,.link-1-color:hover{color:#0062ff}.link-0-color{color:#78a9ff}.color-1{color:#33b1ff}.color-2{color:#a56eff}.color-3{color:#fa4d56}.text-1-color{color:#c6c6c6}.ui-1-color{background-color:#262626}.block{min-height:32rem}.arrow-link{position:relative;display:inline-block}.arrow-link:before{content:"\21B3";position:absolute;left:-1.5rem;color:currentColor;cursor:pointer}.button-color{background-color:#0062ff}.svg-fill{fill:#f4f4f4}.contact-container{border:1px solid #0062ff}.contact-container:hover{background-color:#0062ff}.icon{fill:#f4f4f4}#blog-content h2{font-size:2.25rem;line-height:2.5rem;margin-top:48px}#blog-content h3{font-size:1.875rem;line-height:2.25rem;margin-top:48px}#blog-content h4{font-size:1.5rem;line-height:2rem;margin-top:48px}#blog-content p{margin-top:24px;font-size:1.125rem;line-height:1.75rem}#blog-content p:first-child:first-letter{font-size:3.5rem;line-height:3.5rem;padding-right:8px;float:left}#blog-content a{color:#78a9ff}#blog-content a:hover{text-decoration:underline}#blog-content strong{font-weight:600}#blog-content pre{margin-top:24px;padding:8px 16px;background:#262626;overflow-x:auto}#blog-content ul{margin-top:16px}#blog-content li{margin-top:4px;font-size:1.125rem;line-height:1.75rem}code[class*=language-],pre[class*=language-]{color:#f4f4f4;background:none;font-family:IBM Plex Mono,Menlo,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#262626}:not(pre)>code[class*=language-]{padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#f4f4f4}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:600}.token.italic{font-style:300}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.31.1"/><title data-react-helmet="true">Build a Database Pt. 3: Write Ahead Log(WAL) | Adam Comer</title><link data-react-helmet="true" rel="canonical" href="https://adambcomer.com/blog/simple-database/wal"/><meta data-react-helmet="true" name="description" content="Guild to building a Write Ahead Log(WAL) for a LSM-Tree database. We look at how RocksDB designed their WAL and build our own for our database."/><meta data-react-helmet="true" property="og:title" content="Build a Database Pt. 3: Write Ahead Log(WAL) | Adam Comer"/><meta data-react-helmet="true" property="og:description" content="Guild to building a Write Ahead Log(WAL) for a LSM-Tree database. We look at how RocksDB designed their WAL and build our own for our database."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:url" content="https://adambcomer.com/blog/simple-database/wal"/><meta data-react-helmet="true" property="og:image" content="https://adambcomer.com/assets/img//assets/img/simple-database-write-ahead-log-cover.jpg"/><meta data-react-helmet="true" property="og:image:width" content="1920"/><meta data-react-helmet="true" property="og:image:height" content="1080"/><script data-react-helmet="true" type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "BlogPosting",
            "mainEntityOfPage": "https://adambcomer.com/blog/simple-database/wal",
            "headline": "Build a Database Pt. 3: Write Ahead Log(WAL)",
            "image": [
                "https://adambcomer.com/assets/img//assets/img/simple-database-write-ahead-log-cover.jpg"
            ],
            "datePublished": "2020-06-19T04:55:44+0000",
            "dateModified": "2021-01-24T19:45:04+0000",
            "author": {
                "@type": "Person",
                "name": "Adam Comer",
                "email": "adambcomer@gmail.com",
                "url": "https://adambcomer.com/",
                "sameAs": [
                    "https://www.facebook.com/adam.comer.779",
                    "https://www.linkedin.com/in/adambcomer",
                    "https://www.instagram.com/adamcomer/",
                    "https://twitter.com/adambcomer",
                    "https://github.com/adambcomer",
                    "https://gitlab.com/adambcomer",
                    "https://knowtworthy.com/blog/author/adambcomer/"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "Adam Comer’s Blog",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://adambcomer.com/blog/assets/img/publisherLogo.png",
                    "width": 283,
                    "height": 60
                }
            },
            "description": "Guild to building a Write Ahead Log(WAL) for a LSM-Tree database. We look at how RocksDB designed their WAL and build our own for our database."
        }
        </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#0062ff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=ec72bdbf6bd56c68def62ccc8a31d6c2"/><link as="script" rel="preload" href="/webpack-runtime-d64c77129ba1c39184f9.js"/><link as="script" rel="preload" href="/framework-305b3707783ccc9d7ca6.js"/><link as="script" rel="preload" href="/app-6ec0cbb52bd0d6f73aa9.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/e407fcddaba2c875df0111317fc0652dd0ba783e-4e5bad16d32ee354d003.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-tsx-7841a7fbb18dc84901ea.js"/><link as="fetch" rel="preload" href="/page-data/blog/simple-database/wal/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="flex flex-row m-6"><div class="flex-1"><span class="flex-1 text-2xl"><a href="/">ADAM COMER</a></span></div><div class="flex flex-row hidden lg:block"><span class="mx-4 text-lg hover:underline"><a href="/">Home</a></span><span class="mx-4 text-lg hover:underline"><a href="/blog">Blog</a></span><span class="mx-4 text-lg hover:underline"><a href="/projects">Projects</a></span><span class="mx-4 text-lg hover:underline"><a href="/experience">Experience</a></span></div><svg class="icon lg:hidden" version="1.1" id="icon" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="32px" height="32px" viewBox="0 0 32 32"><rect x="14" y="4" width="4" height="4"></rect><rect x="4" y="4" width="4" height="4"></rect><rect x="24" y="4" width="4" height="4"></rect><rect x="14" y="14" width="4" height="4"></rect><rect x="4" y="14" width="4" height="4"></rect><rect x="24" y="14" width="4" height="4"></rect><rect x="14" y="24" width="4" height="4"></rect><rect x="4" y="24" width="4" height="4"></rect><rect x="24" y="24" width="4" height="4"></rect></svg></nav><main class="px-6 max-w-4xl"><h1 class="text-6xl font-light mt-16">Build a Database Pt. 3: Write Ahead Log(WAL)</h1><p class="text-xl mt-16">Adam Comer</p><p class="text-xl font-light">Updated <!-- -->Jan 24, 2021</p><div id="blog-content" class="my-16"><p>Last article, <a href="/blog/simple-database/memtable">we created our MemTable for in-memory record storage</a>. To recover our data after the database restarts, we need our first layer of on-disk persistence, the WAL. Looking at RocksDB, we will discuss the design and structure of its WAL. After analyzing the standard, we will design a specification for our WAL. Furthermore, we will debate the tradeoffs of Buffered vs Unbuffered I/O in the context of data integrity and disk speed. Lastly, we will build our variant of the WAL in Rust.</p>
<h2>What is a Write Ahead Log(WAL)?</h2>
<p>When a record is written to our database, it is stored in two palaces: the MemTable and the WAL. The WAL acts as an on-disk backup for the MemTable by keeping a running record of all of the database operations. In the event of a restart, the MemTable can be fully recovered by replaying the operations in the WAL. When a MemTable reaches capacity and is transformed into a SSTable, the WAL is wiped from the disk to make room for a new WAL.</p>
<p>As mentioned in <a href="/blog/simple-database/memtable">part two</a>, the key insight of a LSM-Tree database is that sequential I/O is faster than random I/O, and databases should match this reality. The WAL uses exclusively sequential I/O to store data on disk; but, there are drawbacks to not using random I/O. The WAL pays for its improved write speed with lost disk space. Every time a record is updated, old versions of the record are kept, eating away at disk space. This is known as <a href="http://smalldatum.blogspot.com/2015/11/read-write-space-amplification-pick-2_23.html">Space Amplification</a> in database design theory. Space Amplification is a multiple of how much storage space is used for a given dataset size. For example, a 1GB dataset with a 2X Space Amplification factor would result in 2GB of disk usage. Although not important for our project, it is something that database designers are cognizant of and optimize for.</p>
<h2>Buffered vs Unbuffered I/O</h2>
<p>A hot topic for debate in database design is Buffered vs Unbuffered I/O. Today, applications are demanding more from databases while the underlying disks aren’t keeping pace. To make disks appear faster, the OS maps sections of disk to memory. Changes to the disk happen only in memory, and periodically, the OS writes the changes to the physical disk. This is known as Buffered I/O — which writes data to a buffer that is eventually flushed to disk. Buffered I/O can be avoided by using Unbuffered I/O — which writes data directly to the physical disk. </p>
<p><a href="https://github.com/google/leveldb/blob/master/doc/index.md#synchronous-writes">According to Google’s LevelDB, RocksDB’s predecessor, Buffered I/O can be “thousand times as fast as synchronous writes.”</a> Although there is a clear performance benefit, if the OS or the physical server crash, all of the buffered writes are lost. This may be an acceptable risk if there is a replication strategy of the underlying data or the data can be regenerated easily. </p>
<h2>RocksDB WAL</h2>
<p>The <a href="https://github.com/facebook/rocksdb/wiki/Write-Ahead-Log">RocksDB variant of the WAL</a> doesn’t deviate far from the description of the WAL. It is a stream of database operations stored on disk, no extra data structures. RocksDB opts to store records from the WAL in a block format. Each block is 32KB and contains at most one record. Records that are larger than a block are broken into multiple block size chunks. At the start of each block is a checksum of the block’s contents to verify its integrity. The full block format, <a href="https://github.com/facebook/rocksdb/wiki/Write-Ahead-Log-File-Format#record-format">copied from the github repository</a>, is below:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">+----------+-----------+-----------+----------------+--- ... ---+
| CRC (4B) | Size (2B) | Type (1B) | Log number (4B)| Payload   |
+----------+-----------+-----------+----------------+--- ... ---+
CRC = 32bit hash computed over the payload using CRC
Size = Length of the payload data
Type = Type of record
       (kZeroType, kFullType, kFirstType, kLastType, kMiddleType )
       The type is used to group a bunch of records together to represent
       blocks that are larger than kBlockSize
Payload = Byte stream as long as specified by the payload size
Log number = 32bit log file number, so that we can distinguish between
records written by the most recent log writer vs a previous one.</code></pre></div>
<p>Immediately when I saw that RocksDB was using a block model, I was surprised because small records would leave many padding bytes, wasting disk space. The designers of RocksDB know this and <a href="https://github.com/facebook/rocksdb/wiki/Write-Ahead-Log-File-Format#downsides">left a comment about it in the drawbacks section</a>; but, they use it with good reason. Tools like MapReduce can take advantage of this block design and use it to split files into parts for batch processing jobs. Although I will never use this, there are probably some processing jobs at Facebook that need to process the archived WALs from RocksDB. </p>
<p>When it comes to Buffered I/O, <a href="https://rocksdb.org/blog/2017/08/25/flushwal.html">RocksDB uses the OS write buffer and gives the user the option to force the OS to sync it to disk</a>. This follows the LevelDB design, guaranteeing the data can be recovered if the process crashes.</p>
<h2>Our WAL</h2>
<p>For our database, the WAL will directly follow the description and won’t include block models or checksums, like in RocksDB. Each of the entries will be stored back-to-back with only the necessary metadata to recover the keys and values of the records. This will reduce the amount of lost disk space and programming overhead. For our WAL, each entry will follow this format:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">+---------------+---------------+-----------------+-...-+--...--+-----------------+
| Key Size (8B) | Tombstone(1B) | Value Size (8B) | Key | Value | Timestamp (16B) |
+---------------+---------------+-----------------+-...-+--...--+-----------------+
Key Size = Length of the Key data
Tombstone = If this record was deleted and has a value
Value Size = Length of the Value data
Key = Key data
Value = Value data
Timestamp = Timestamp of the operation in microseconds</code></pre></div>
<p>Like RocksDB, and LevelDB before it, we will use the Buffered I/O model, and flush the data to the OS after each write. When deciding to use Buffered or Unbuffered I/O, I believe we can trust Google and Facebook to inform us that Buffered I/O is an acceptable risk.</p>
<h2>Building Our WAL</h2>
<p>The code for the WAL will exist in two parts, the <code class="language-text">WAL</code> itself and the <code class="language-text">WALIterator</code>. At a high level, the <code class="language-text">WAL</code> is the struct that our database will interface with. The <code class="language-text">WALIterator</code> is a consumable iterator that reads all of the entries of a WAL file. We will build the <code class="language-text">WALIterator</code> first because the <code class="language-text">WAL</code> uses the <code class="language-text">WALIterator</code> in its recovery method.</p>
<h3>WALEntry Struct</h3>
<p>First, we need to define the structure of our WAL entries. This will mirror the <a href="/blog/simple-database/memtable">MemTableEntry in the prior article</a>. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">WALEntry</span> <span class="token punctuation">{</span>
 <span class="token keyword">pub</span> key<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span>
 <span class="token keyword">pub</span> value<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">>></span><span class="token punctuation">,</span>
 <span class="token keyword">pub</span> timestamp<span class="token punctuation">:</span> <span class="token keyword">u128</span><span class="token punctuation">,</span>
 <span class="token keyword">pub</span> deleted<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>WALIterator Struct</h3>
<p>Next, we have our WAL iterator. Its job is to start at the beginning of a WAL file and iterate over each entry. This will aid in the reconstruction process of the MemTable when our database restarts. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// WAL iterator to iterate over the items in a WAL file.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">WALIterator</span> <span class="token punctuation">{</span>
 reader<span class="token punctuation">:</span> <span class="token class-name">BufReader</span><span class="token operator">&lt;</span><span class="token class-name">File</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Although there is a lot of overhead of reading and deserializing, we push most of this complexity onto the standard library’s <code class="language-text">BufReader</code>. It reads the data from our WAL file letting our iterator focus on deserializing the entries. Additionally, it <a href="https://doc.rust-lang.org/std/io/struct.BufWriter.html">reduces the amount of disk operations by reading files in 8KB</a> chunks for maximum read efficiency. </p>
<p>Note, the <code class="language-text">BufReader</code> is a Rust abstraction and is not the same as the OS’s Buffered I/O. This is an important distinction because an application can use an Unbuffered I/O solution in the code but the OS will still buffer the writes, if not properly configured. By using both OS buffering and Rust buffering, the two layers of buffering maximize the read performance of our WAL.</p>
<h3>WALIterator Impl</h3>
<p>In order to be classified as an iterator, the <code class="language-text">WALIterator</code> needs to implement the <code class="language-text">Iterator</code> trait in addition to its own methods.</p>
<h4>new()</h4>
<p>Starting with the <code class="language-text">WALIterator</code>’s custom method, we need a basic constructor method. It will open a file in read-only mode for the <code class="language-text">BufReader</code>. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Creates a new WALIterator from a path to a WAL file.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">WALIterator</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> reader <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">WALIterator</span> <span class="token punctuation">{</span> reader <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>next()</h4>
<p>To implement the <code class="language-text">Iterator</code> trait, a <code class="language-text">Item</code> type and <code class="language-text">next()</code> method need to be defined. The Item type of the iterator will be the WALEntry that was defined before. The <code class="language-text">next()</code> method will deserialize the next entry from a WAL file with the format from our specification. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">WALIterator</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">WALEntry</span><span class="token punctuation">;</span>
 
  <span class="token comment">/// Gets the next entry in the WAL file.</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">WALEntry</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> len_buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> len_buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> key_len <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token function">from_le_bytes</span><span class="token punctuation">(</span>len_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> bool_buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> bool_buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> deleted <span class="token operator">=</span> bool_buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> key <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> key_len<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> value <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> deleted <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> len_buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> value_len <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token function">from_le_bytes</span><span class="token punctuation">(</span>len_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> <span class="token keyword">mut</span> value_buf <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> value_len<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> value_buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      value <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> timestamp_buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> timestamp_buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> timestamp <span class="token operator">=</span> <span class="token keyword">u128</span><span class="token punctuation">::</span><span class="token function">from_le_bytes</span><span class="token punctuation">(</span>timestamp_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">WALEntry</span> <span class="token punctuation">{</span>
      key<span class="token punctuation">,</span>
      value<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
      deleted<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Deserializing entries can be tedious, so it’s best to package the process into a general purpose iterator. Now, reading WAL files is as simple as instantiating a new <code class="language-text">WALIterator</code>.
If a full entry can’t be read because it is corrupted or partially written, the iterator will stop. In a production database, there would be an error correction process to clean up the WAL and notify the user. We won’t worry about this because it would drastically increase the complexity of the iterator at the expense of our understanding. Things like error correction deserve a blog post all to themselves.</p>
<p>This method completes the <code class="language-text">WALIterator</code>. The full version can be found <a href="https://github.com/adambcomer/database-engine/blob/master/src/wal_iterator.rs">here</a> if any additional clarity is needed.</p>
<h3>WAL Struct</h3>
<p>Now to the main event, actually building the <code class="language-text">WAL</code> for our database. Like the <code class="language-text">WALIterator</code>, we will use a buffered I/O design but as a writer, not a reader. This writer will exclusively append records to the file.</p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Write Ahead Log(WAL)</span>
<span class="token comment">///</span>
<span class="token comment">/// An append-only file that holds the operations performed on the MemTable.</span>
<span class="token comment">/// The WAL is intended for recovery of the MemTable when the server is shutdown.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">WAL</span> <span class="token punctuation">{</span>
 path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span><span class="token punctuation">,</span>
 file<span class="token punctuation">:</span> <span class="token class-name">BufWriter</span><span class="token operator">&lt;</span><span class="token class-name">File</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>WAL Impl</h3>
<h4>new()</h4>
<p>Like always, a constructor is necessary to instantiate a new <code class="language-text">WAL</code>. Given a directory, a new WAL file is created with the current time in microseconds. In the case of multiple WAL files in the same directory, the timestamps allow the recovery process to apply the operations in order.</p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Creates a new WAL in a given directory.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>dir<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token constant">WAL</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timestamp <span class="token operator">=</span> <span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">duration_since</span><span class="token punctuation">(</span><span class="token constant">UNIX_EPOCH</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as_micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".wal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token class-name">BufWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token constant">WAL</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> file <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>from_path()</h4>
<p>If a WAL file already exists, we want to instantiate it from the file’s path. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Creates a WAL from an existing file path.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_path</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token constant">WAL</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token class-name">BufWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token constant">WAL</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
    file<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>set()</h4>
<p>When a new Key-Value pair is written to the database, it is first written to the <code class="language-text">MemTable</code> and <code class="language-text">WAL</code>. Our set method takes in the record, serializes the data, and appends it to the <code class="language-text">WAL</code>. This function uses the layout defined in the design above.</p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Sets a Key-Value pair and the operation is appended to the WAL.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">:</span> <span class="token keyword">u128</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timestamp<span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here we can see the value of the <code class="language-text">BufWriter</code>. The metadata, such as the tombstones and key-value lengths, is only a few bytes and warrants batching write operations.</p>
<h4>delete()</h4>
<p>Adding a delete operation is similar to the set method, just without the value.</p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Deletes a Key-Value pair and the operation is appended to the WAL.</span>
<span class="token comment">///</span>
<span class="token comment">/// This is achieved using tombstones.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">:</span> <span class="token keyword">u128</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timestamp<span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>flush()</h4>
<p>After we set or delete a record, the contents of the operation haven’t been passed to the OS to write to disk. The flush method takes the modified buffer in the <code class="language-text">BufWriter</code> and stores it. Although we could call this method at the end of set and delete, separating these concerns gives the database the ability to bulk insert records without flushing to disk after each operation. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Flushes the WAL to disk.</span>
<span class="token comment">///</span>
<span class="token comment">/// This is useful for applying bulk operations and flushing the final result to</span>
<span class="token comment">/// disk. Waiting to flush after the bulk operations have been performed will improve</span>
<span class="token comment">/// write performance substantially.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">flush</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Luckily, the <code class="language-text">BufWriter</code> knows this is a common design pattern and has a built-in flush method.</p>
<h4>load<em>from</em>dir()</h4>
<p>In most of my coding projects, I include a <a href="https://github.com/adambcomer/database-engine/blob/master/src/utils.rs">utilities file for all miscellaneous functions</a> that are used repeatedly throughout the application. One common task our database does is searching for files with an extension. Given a folder, this function will do just that. </p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Gets the set of files with an extension for a given directory.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">files_with_ext</span><span class="token punctuation">(</span>dir<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ext<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">PathBuf</span><span class="token operator">></span> <span class="token punctuation">{</span>
 <span class="token keyword">let</span> <span class="token keyword">mut</span> files <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> file <span class="token keyword">in</span> <span class="token function">read_dir</span><span class="token punctuation">(</span><span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> path <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> path<span class="token punctuation">.</span><span class="token function">extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ext <span class="token punctuation">{</span>
     files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 files
<span class="token punctuation">}</span></code></pre></div>
<p>To restore our <code class="language-text">MemTable</code> and <code class="language-text">WAL</code>, we need to load the operations from the WALs in a directory and replay them to a new <code class="language-text">MemTable</code> and <code class="language-text">WAL</code>. Using our helper function from above and our <code class="language-text">WALIterator</code>, we will find the WAL files and replay their operations. Lastly, when the replay is finished, we flush the contents to disk and delete the old WALs.</p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token comment">/// Loads the WAL(s) within a directory, returning a new WAL and the recovered MemTable.</span>
<span class="token comment">///</span>
<span class="token comment">/// If multiple WALs exist in a directory, they are merged by file date.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">load_from_dir</span><span class="token punctuation">(</span>dir<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token constant">WAL</span><span class="token punctuation">,</span> <span class="token class-name">MemTable</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> wal_files <span class="token operator">=</span> <span class="token function">files_with_ext</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">"wal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  wal_files<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> new_mem_table <span class="token operator">=</span> <span class="token class-name">MemTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> new_wal <span class="token operator">=</span> <span class="token constant">WAL</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> w_f <span class="token keyword">in</span> wal_files<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>wal<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">WAL</span><span class="token punctuation">::</span><span class="token function">from_path</span><span class="token punctuation">(</span>w_f<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> entry <span class="token keyword">in</span> wal<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> entry<span class="token punctuation">.</span>deleted <span class="token punctuation">{</span>
          new_mem_table<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
          new_wal<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          new_mem_table<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
            entry<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entry<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          new_wal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
            entry<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entry<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  new_wal<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  wal_files<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>f<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">remove_file</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>new_wal<span class="token punctuation">,</span> new_mem_table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Simply, this function iterates over every WAL file and entry, reconstructing the original <code class="language-text">MemTable</code>. </p>
<h2>Conclusion</h2>
<p>Now that we have completed the WAL, our database has its first level of persistence down. Comparing the designs of the RocksDB WAL and our WAL, we see that they are not very different. RocksDB, being a professional database, uses data integrity features like checksums and a block model for its disk layout. But, the main principle of a running log of operations is maintained between the two variants. When writing data to disk, we ran into the problem that the OS doesn’t immediately propagate those writes. Therein lies a tradeoff of speed and data integrity. Buffered I/O chooses speed over data integrity. Although there are risks, many production databases use this method because the probability of a machine crashing is low compared to the process crashing; and with a sufficient replication strategy — these problems vanish. <a href="https://github.com/adambcomer/database-engine/blob/master/src/wal.rs">The complete WAL component can be found in this repository along with unit tests</a>. Next, we will implement the SSTable component of our database so our database can hold more than a single MemTables worth of data.</p>
<h2>Index</h2>
<ul>
<li><a href="/blog/simple-database/motivation-design">Build a Database Pt. 1: Motivation &#x26; Design</a></li>
<li><a href="/blog/simple-database/memtable">Build a Database Pt. 2: MemTable</a></li>
<li>Build a Database Pt. 3: Write Ahead Log(WAL)</li>
</ul></div></main><hr/><footer class="grid lg:grid-cols-12 m-6"><div class="lg:col-span-8"><span class="text-2xl">ADAM COMER</span><div class="flex flex-row mt-6"><div class="mr-4"><a href="mailto:adambcomer@gmail.com"><svg class="icon w-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M28,6H4A2,2,0,0,0,2,8V24a2,2,0,0,0,2,2H28a2,2,0,0,0,2-2V8A2,2,0,0,0,28,6ZM25.8,8,16,14.78,6.2,8ZM4,24V8.91l11.43,7.91a1,1,0,0,0,1.14,0L28,8.91V24Z" transform="translate(0)"></path></svg></a></div><div class="mx-4"><a href="https://www.linkedin.com/in/adambcomer"><svg class="icon w-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M26.21,4H5.79A1.78,1.78,0,0,0,4,5.73V26.2a1.77,1.77,0,0,0,1.79,1.73H26.21A1.77,1.77,0,0,0,28,26.2V5.73A1.78,1.78,0,0,0,26.21,4ZM11.11,24.41H7.59V13h3.52Zm-1.72-13A2.07,2.07,0,0,1,7.32,9.39,2,2,0,0,1,9.39,7.32a2.07,2.07,0,0,1,0,4.13ZM24.48,24.34H21V18.76c0-1.33,0-3.06-1.86-3.06S17,17.16,17,18.63v5.65H13.44V13h3.32V14.5h.07a3.72,3.72,0,0,1,3.39-1.86c3.59,0,4.26,2.4,4.26,5.45Z" transform="translate(0 0)"></path></svg></a></div><div class="mx-4"><a href="https://github.com/adambcomer"><svg class="icon w-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M16,2a14,14,0,0,0-4.43,27.28c.7.13,1-.3,1-.67s0-1.21,0-2.38c-3.89.84-4.71-1.88-4.71-1.88A3.71,3.71,0,0,0,6.24,22.3c-1.27-.86.1-.85.1-.85A2.94,2.94,0,0,1,8.48,22.9a3,3,0,0,0,4.08,1.16,2.93,2.93,0,0,1,.88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4,5.4,0,0,1,1.44-3.76,5,5,0,0,1,.14-3.7s1.17-.38,3.85,1.43a13.3,13.3,0,0,1,7,0c2.67-1.81,3.84-1.43,3.84-1.43a5,5,0,0,1,.14,3.7,5.4,5.4,0,0,1,1.44,3.76c0,5.38-3.27,6.56-6.39,6.91a3.33,3.33,0,0,1,.95,2.59c0,1.87,0,3.38,0,3.84s.25.81,1,.67A14,14,0,0,0,16,2Z"></path></svg></a></div><div class="mx-4"><a href="https://twitter.com/adambcomer"><svg class="icon w-8" xmlns="http://www.w3.org/2000/svg" viewBox="2 2 27 27"><path d="M11.92,24.94A12.76,12.76,0,0,0,24.76,12.1c0-.2,0-.39,0-.59A9.4,9.4,0,0,0,27,9.18a9.31,9.31,0,0,1-2.59.71,4.56,4.56,0,0,0,2-2.5,8.89,8.89,0,0,1-2.86,1.1,4.52,4.52,0,0,0-7.7,4.11,12.79,12.79,0,0,1-9.3-4.71,4.51,4.51,0,0,0,1.4,6,4.47,4.47,0,0,1-2-.56v.05A4.53,4.53,0,0,0,9.5,17.83a4.53,4.53,0,0,1-2,.08A4.51,4.51,0,0,0,11.68,21,9.05,9.05,0,0,1,6.07,23,9.77,9.77,0,0,1,5,22.91a12.77,12.77,0,0,0,6.92,2" transform="translate(0)"></path></svg></a></div><div class="mx-4"><a href="https://www.instagram.com/adamcomer/"><svg class="icon w-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><circle cx="22.4056" cy="9.5944" r="1.44"></circle><path d="M16,9.8378A6.1622,6.1622,0,1,0,22.1622,16,6.1622,6.1622,0,0,0,16,9.8378ZM16,20a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"></path><path d="M16,6.1622c3.2041,0,3.5837.0122,4.849.07a6.6418,6.6418,0,0,1,2.2283.4132,3.9748,3.9748,0,0,1,2.2774,2.2774,6.6418,6.6418,0,0,1,.4132,2.2283c.0577,1.2653.07,1.6449.07,4.849s-.0122,3.5837-.07,4.849a6.6418,6.6418,0,0,1-.4132,2.2283,3.9748,3.9748,0,0,1-2.2774,2.2774,6.6418,6.6418,0,0,1-2.2283.4132c-1.2652.0577-1.6446.07-4.849.07s-3.5838-.0122-4.849-.07a6.6418,6.6418,0,0,1-2.2283-.4132,3.9748,3.9748,0,0,1-2.2774-2.2774,6.6418,6.6418,0,0,1-.4132-2.2283c-.0577-1.2653-.07-1.6449-.07-4.849s.0122-3.5837.07-4.849a6.6418,6.6418,0,0,1,.4132-2.2283A3.9748,3.9748,0,0,1,8.9227,6.6453a6.6418,6.6418,0,0,1,2.2283-.4132c1.2653-.0577,1.6449-.07,4.849-.07M16,4c-3.259,0-3.6677.0138-4.9476.0722A8.8068,8.8068,0,0,0,8.14,4.63,6.1363,6.1363,0,0,0,4.63,8.14a8.8068,8.8068,0,0,0-.5578,2.9129C4.0138,12.3323,4,12.741,4,16s.0138,3.6677.0722,4.9476A8.8074,8.8074,0,0,0,4.63,23.8605a6.1363,6.1363,0,0,0,3.51,3.51,8.8068,8.8068,0,0,0,2.9129.5578C12.3323,27.9862,12.741,28,16,28s3.6677-.0138,4.9476-.0722a8.8074,8.8074,0,0,0,2.9129-.5578,6.1363,6.1363,0,0,0,3.51-3.51,8.8074,8.8074,0,0,0,.5578-2.9129C27.9862,19.6677,28,19.259,28,16s-.0138-3.6677-.0722-4.9476A8.8068,8.8068,0,0,0,27.37,8.14a6.1363,6.1363,0,0,0-3.51-3.5095,8.8074,8.8074,0,0,0-2.9129-.5578C19.6677,4.0138,19.259,4,16,4Z"></path></svg></a></div></div></div><div class="lg:col-span-4 mt-12 lg:mt-0"><div class="text-lg font-semibold">Directory</div><div class="mt-2 text-lg hover:underline"><a href="/">Home</a></div><div class="mt-2 text-lg hover:underline"><a href="/blog">Blog</a></div><div class="mt-2 text-lg hover:underline"><a href="/projects">Projects</a></div><div class="mt-2 text-lg hover:underline"><a href="/experience">Experience</a></div></div><div class="lg:col-span-12 mt-12 lg:mt-0">© 2021 Adam Comer — All rights reserved</div></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-129077573-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/simple-database/wal";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d47b21a5737d9524fa70.js"],"app":["/app-6ec0cbb52bd0d6f73aa9.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-7ed35ec75042d70f8cdf.js"],"component---src-pages-blog-simple-database-tsx":["/component---src-pages-blog-simple-database-tsx-b9a4e2bc7d0978cb7fb1.js"],"component---src-pages-blog-tsx":["/component---src-pages-blog-tsx-d2bd40793eb152fdc67c.js"],"component---src-pages-experience-tsx":["/component---src-pages-experience-tsx-492420e54540bc2c7fbf.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-44bb29c7bd4b221ca37c.js"],"component---src-pages-projects-tsx":["/component---src-pages-projects-tsx-4b73369e6d4589d5bf98.js"],"component---src-templates-blog-post-tsx":["/component---src-templates-blog-post-tsx-7841a7fbb18dc84901ea.js"]};/*]]>*/</script><script src="/polyfill-d47b21a5737d9524fa70.js" nomodule=""></script><script src="/component---src-templates-blog-post-tsx-7841a7fbb18dc84901ea.js" async=""></script><script src="/e407fcddaba2c875df0111317fc0652dd0ba783e-4e5bad16d32ee354d003.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-6ec0cbb52bd0d6f73aa9.js" async=""></script><script src="/framework-305b3707783ccc9d7ca6.js" async=""></script><script src="/webpack-runtime-d64c77129ba1c39184f9.js" async=""></script></body></html>